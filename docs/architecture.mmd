flowchart TB
  User[User] --> ALB[ALB HTTPS]
  User --> APIGW[API Gateway HTTP API]

  WAF[WAF optional attach only rules out of scope] -.-> ALB

  subgraph Environment
    direction TB

    subgraph VPC
      direction TB

      subgraph PublicSubnets[Public subnets x2]
        ALB
        NAT[NAT gateway shared or per az]
      end

      subgraph PrivateSubnets[Private subnets x2]
        Compute["Compute module ECS or Kubernetes (self managed or EKS)"]
        ECS[ECS service]
        K8s[Kubernetes self managed]
        EKS[EKS managed]
        Lambda[Lambda in private subnets]
        RDS[RDS PostgreSQL]
      end
    end

    subgraph Observability[Observability per environment]
      CloudWatch[CloudWatch metrics and logs]
    end

    Guardrail[Terraform deploy guardrail estimated_monthly_cost required]
  end

  Compute --> ECS
  Compute --> K8s
  Compute --> EKS

  ALB --> Compute
  APIGW --> Lambda

  Lambda --> RDS
  ECS --> RDS
  K8s --> RDS
  EKS --> RDS

  ECS --> NAT
  K8s --> NAT
  EKS --> NAT

  ECR[ECR repository] -.-> Compute
  Compute --> CloudWatch
  Lambda --> CloudWatch
  RDS --> CloudWatch

  Guardrail -.-> Compute
  Guardrail -.-> Lambda
  Guardrail -.-> RDS
