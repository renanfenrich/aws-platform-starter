# Terraform Skillbook (Repo-Local)

This is a practical, repo-specific guide for how we write, test, and release Terraform here. It is intentionally small and opinionated so changes stay safe and easy to review.

See `docs/terraform/ATTRIBUTION.md` for the upstream attribution note.

## Module standards

### Structure
- Required: `main.tf`, `variables.tf`, `outputs.tf`, `README.md`.
- Optional (only when needed): `locals.tf`, `data-sources.tf`, `versions.tf`, `tests/*.tftest.hcl`, `examples/`.
- Keep one module = one responsibility. If the module starts needing unrelated flags, it probably wants a sibling module.

### Naming and tags
- Follow existing `name_prefix`, `environment`, and `tags` patterns. All resources must carry required cost tags (`Project`, `Environment`, `Service`, `Owner`, `CostCenter`, `ManagedBy`, `Repository`).
- Prefer `enable_*` toggles over implicit behavior.

### Inputs
- Always specify `type` and add `validation` for guardrails.
- Use `nullable = true` only when `null` is a legitimate signal (for example, "unset means disabled").
- Keep defaults safe-by-default (especially in prod).

### Outputs
- Export only what callers need; avoid exposing entire resources or dumping large objects.
- Mark secrets or ARNs as `sensitive` when they should not be printed.
- Keep outputs stable across modes (`platform`, `ecs_capacity_mode`) so environment wiring stays consistent.

### Examples
- Add `examples/` when a module has non-obvious wiring or can stand alone.
- Example directories should be minimal and runnable; keep them aligned with default vars.

### Docs generation
- Module docs are generated by `terraform-docs` and injected into each module `README.md`.
- Run `make docs` after changing variables or outputs. CI uses `make docs-check`.

## Versioning and release strategy (modules)

This repo is a monorepo; modules are usually consumed here. If a module is shared externally:

- Use SemVer for module releases.
- Tag format: `module-<name>-vX.Y.Z` (example: `module-ecs-v1.2.0`).
- Breaking changes must bump the major version and include a short migration note in the PR and release notes.
- Keep release notes short and specific: what changed, why, and any user action.

## Testing decision matrix

| Change type | Preferred test | Why |
| --- | --- | --- |
| Pure module logic or input validation | `terraform test` in the module directory | Fast, backendless, deterministic |
| Stack wiring or selector changes | `tests/terraform` (`*.tftest.hcl`) | Covers `platform` and capacity modes without AWS |
| Provider behavior or AWS integration | Terratest (optional) | Validates real API behavior |
| Full environment workflows | Kitchen-style integration | End-to-end confidence for critical paths |

Recommended pipeline order:
1) `fmt`/`validate`
2) `tflint`/`tfsec`
3) `terraform test`
4) plan
5) integration
6) e2e

## CI/CD patterns

- **Plan/apply separation**: PRs run checks and generate a plan. Apply is manual and only from a reviewed commit.
- **Environment promotion**: promote a single commit from dev to prod; avoid "hotfix only in prod".
- **State safety**: remote state lives in `bootstrap/` with encryption and native locking. CI validation uses `-backend=false`.
- **Drift detection**: schedule `terraform plan -refresh-only` (weekly for prod, monthly for dev) and review changes.

## Security and compliance checklist

- Secrets live in Secrets Manager or SSM Parameter Store; never in git.
- IAM is least-privilege; avoid `*` for actions and resources.
- No public SSH ingress; use SSM if access is needed.
- Encrypt data at rest (S3, RDS, SNS, and any logs storing sensitive data).
- CI runs `tfsec`; `tflint` is the baseline config lint. Add policy-as-code (OPA/Conftest or equivalent) only when you need enforceable org rules.

## DO / DON'T

**DO**
- Keep diffs small and focused.
- Add validations for every new variable.
- Update module docs with `terraform-docs` when inputs or outputs change.
- Extend tests when selectors or safety defaults change.

**DON'T**
- Add public SSH ingress or unencrypted storage.
- Hide breaking changes in refactors.
- Ship new modules without tests or docs.

## PR checklist (reviewer template)

- [ ] Scope is contained to one module or stack, with clear intent.
- [ ] Inputs are typed and validated; outputs are minimal and stable.
- [ ] Docs updated (`make docs` where needed).
- [ ] Tests updated and passing (`make test`).
- [ ] Security posture unchanged or explicitly justified.
- [ ] Cost and drift implications called out when relevant.
