name: terraform-ci

on:
  pull_request:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to apply"
        required: true
        type: choice
        options:
          - dev
          - prod
          - dr
      platform:
        description: "Optional platform override (ecs | k8s_self_managed | eks)"
        required: false
        default: ""
      run_apply:
        description: "Run apply"
        required: true
        type: boolean
        default: false

jobs:
  checks:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.11.0"

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.53.0

      - name: Fmt
        run: make fmt-check

      - name: Validate
        run: make validate

      - name: Lint
        run: make lint

      - name: Cost estimate (placeholder)
        run: echo "Infracost runs in .github/workflows/ci.yml when INFRACOST_API_KEY is configured."

  changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      run_plan: ${{ steps.detect.outputs.run_plan }}
      matrix: ${{ steps.detect.outputs.matrix }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed stacks
        id: detect
        shell: bash
        run: |
          base_ref="${{ github.base_ref }}"
          if [ -z "$base_ref" ]; then
            echo "run_plan=false" >> "$GITHUB_OUTPUT"
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git fetch origin "$base_ref" --depth=1
          changed=$(git diff --name-only "origin/$base_ref"...HEAD)

          if [ -z "$changed" ]; then
            echo "run_plan=false" >> "$GITHUB_OUTPUT"
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          envs=()
          add_env() { envs+=("$1"); }

          if echo "$changed" | grep -q '^environments/dev/'; then add_env dev; fi
          if echo "$changed" | grep -q '^environments/prod/'; then add_env prod; fi
          if echo "$changed" | grep -q '^environments/dr/'; then add_env dr; fi
          if echo "$changed" | grep -q '^bootstrap/'; then add_env bootstrap; fi
          if echo "$changed" | grep -q '^modules/'; then
            add_env dev
            add_env prod
            add_env dr
          fi

          if [ ${#envs[@]} -eq 0 ]; then
            echo "run_plan=false" >> "$GITHUB_OUTPUT"
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          uniq_envs=($(printf '%s\n' "${envs[@]}" | sort -u))
          json=$(printf '%s\n' "${uniq_envs[@]}" | jq -R . | jq -s .)

          echo "run_plan=true" >> "$GITHUB_OUTPUT"
          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  plan:
    runs-on: ubuntu-latest
    needs: [checks, changes]
    if: needs.changes.outputs.run_plan == 'true'
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.changes.outputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.11.0"

      - name: Plan config
        id: planconfig
        shell: bash
        run: |
          case "${{ matrix.target }}" in
            bootstrap)
              echo "dir=bootstrap" >> "$GITHUB_OUTPUT"
              echo "var_files=-var-file=terraform.tfvars" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "dir=environments/${{ matrix.target }}" >> "$GITHUB_OUTPUT"
              echo "var_files=-var-file=terraform.tfvars -var-file=infracost.tfvars" >> "$GITHUB_OUTPUT"
              ;;
          esac

      - name: Check AWS credentials
        id: aws
        shell: bash
        run: |
          if [ -n "$AWS_ROLE_ARN" ]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
            echo "mode=oidc" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -n "$AWS_ACCESS_KEY_ID" ] && [ -n "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
            echo "mode=keys" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "run=false" >> "$GITHUB_OUTPUT"

      - name: Configure AWS Credentials (OIDC)
        if: steps.aws.outputs.run == 'true' && steps.aws.outputs.mode == 'oidc'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Configure AWS Credentials (static)
        if: steps.aws.outputs.run == 'true' && steps.aws.outputs.mode == 'keys'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Plan
        if: steps.aws.outputs.run == 'true'
        shell: bash
        run: |
          dir="${{ steps.planconfig.outputs.dir }}"
          var_files="${{ steps.planconfig.outputs.var_files }}"

          terraform -chdir="$dir" init -backend=false -input=false
          terraform -chdir="$dir" plan -input=false -lock=false -refresh=false $var_files -out="plan-${{ matrix.target }}.tfplan"

      - name: Upload plan artifact
        if: steps.aws.outputs.run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ matrix.target }}
          path: ${{ steps.planconfig.outputs.dir }}/plan-${{ matrix.target }}.tfplan

      - name: Skip plan (missing AWS creds)
        if: steps.aws.outputs.run != 'true'
        run: echo "Skipping plan for ${{ matrix.target }} because AWS credentials are not configured."

  apply:
    runs-on: ubuntu-latest
    needs: [checks]
    if: github.event_name == 'workflow_dispatch' && inputs.run_apply
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.11.0"

      - name: Check AWS credentials
        id: aws
        shell: bash
        run: |
          if [ -n "$AWS_ROLE_ARN" ]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
            echo "mode=oidc" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -n "$AWS_ACCESS_KEY_ID" ] && [ -n "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
            echo "mode=keys" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "run=false" >> "$GITHUB_OUTPUT"

      - name: Configure AWS Credentials (OIDC)
        if: steps.aws.outputs.run == 'true' && steps.aws.outputs.mode == 'oidc'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Configure AWS Credentials (static)
        if: steps.aws.outputs.run == 'true' && steps.aws.outputs.mode == 'keys'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Apply
        if: steps.aws.outputs.run == 'true'
        shell: bash
        run: |
          env_name="${{ inputs.environment }}"
          platform="${{ inputs.platform }}"

          terraform -chdir="environments/$env_name" init -backend-config=backend.hcl

          if [ -n "$platform" ]; then
            terraform -chdir="environments/$env_name" apply -auto-approve -var-file=terraform.tfvars -var "platform=$platform"
          else
            terraform -chdir="environments/$env_name" apply -auto-approve -var-file=terraform.tfvars
          fi

      - name: Apply blocked (missing AWS creds)
        if: steps.aws.outputs.run != 'true'
        run: |
          echo "AWS credentials are required for apply. Set AWS_ROLE_ARN or AWS_ACCESS_KEY_ID/AWS_SECRET_ACCESS_KEY."
          exit 1
