name: kubernetes-ci

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  kubernetes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      KUBECONFORM_VERSION: v0.6.4
      CONFTEST_VERSION: v0.45.0

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect Kubernetes changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            k8s:
              - 'k8s/**'
              - 'charts/**'
              - 'docs/kubernetes/**'
              - 'policy/kubernetes/**'
              - 'scripts/kubernetes/**'

      - name: Setup kubectl
        if: steps.changes.outputs.k8s == 'true'
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.2'

      - name: Setup Python
        if: steps.changes.outputs.k8s == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Go
        if: steps.changes.outputs.k8s == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.6'

      - name: Install Kubernetes tooling
        if: steps.changes.outputs.k8s == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install yamllint
          go install github.com/yannh/kubeconform/cmd/kubeconform@${KUBECONFORM_VERSION}
          go install github.com/open-policy-agent/conftest@${CONFTEST_VERSION}
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: K8s validate
        if: steps.changes.outputs.k8s == 'true'
        run: make k8s-validate

      - name: K8s lint
        if: steps.changes.outputs.k8s == 'true'
        run: make k8s-lint

      - name: K8s policy
        if: steps.changes.outputs.k8s == 'true'
        run: make k8s-policy

      - name: K8s security
        if: steps.changes.outputs.k8s == 'true'
        run: make k8s-sec
